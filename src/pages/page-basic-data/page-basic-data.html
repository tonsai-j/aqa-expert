<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../layout/shared-styles.html">
<link rel="import" href="../../layout/flexbox-grid.html">
<!-- <link rel="import" href="../../../redux/profile/page-01-redux.html"> -->
<link rel="import" href="../../redux/register/register-redux.html">
<link rel="import" href="../../redux-mixin.html">
<link rel="import" href="../../mixins/animate-mixin.html">
<link rel="import" href="../../i18n/profile/page-01-i18n.html">
<link rel="import" href="../../mixins/common-mixin.html">
<!-- <link rel="import" href="../../../components/nylon-animate-css/nylon-animate-css.html"> -->
<link rel="import" href="../../components/aqa-panel/aqa-panel.html">
<link rel="import" href="../../components/aqa-form/aqa-input.html">
<link rel="import" href="../../components/aqa-button/aqa-button.html">
<link rel="import" href="../../components/aqa-title/aqa-title-name.html">
<link rel="import" href="../../components/aqa-form/aqa-date-picker.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../components/aqa-form/aqa-combo-box.html">


<dom-module id="page-basic-data">
    <template>
        <!-- <style include="nylon-animate-css"></style> -->
        <style include="flexbox-grid shared-styles">
            /* #example-sizing-contain {
                width: 100%;
                height: auto;
            } */

            #output_image {
                width: 100%;
                height: auto;
                min-width: 96px;
                min-height: auto;
                margin: 0 auto;
            }

            img {
                width: 100px;
                hyphens: 100px;
            }

            .img-circle {
                width: 30px;
                height: 30px;
                border-radius: 50%;
            }

            .flex-container {
                display: flex;
                justify-content: space-between;
            }

            .header-content>b {
                font-family: MitrLight;
            }

            .flex {
                display: flex;
            }

            .flex-item {
                margin: 0 auto;
            }

            .groove {
                border: 1px solid #cdcdcd;
            }
        </style>
        <!-- 55555555555555555555555555555555555555555
        <p class="groove">A groove border.</p> -->
        <aqa-title-name item=[[info.basic]]></aqa-title-name>
        <aqa-panel id="basic">
            <app-toolbar slot="header">
                <div main-title>ข้อมูลพื้นฐานสถานศึกษา</div>
            </app-toolbar>

            <div slot="content">
                <div class="groove">
                    55555555555555555555
                    <!-- <div class="row center-sm" style="text-align:left">
                        <div class=" col-xs-12 col-lg-10">
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                    <aqa-input class="form " label="รหัสสถานศึกษา" value="[[info.id]]" disabled></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                    <aqa-input label="[[i18n.page01.status]]" value="[[info.type_assessor.ASSESSORTYPDESC]]" disabled></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-md-12 col-lg-4">
                                    <aqa-combo-box always-float-label label="[[i18n.page01.academic]]" items='{{academicList}}' value="{{data.type_academic_id}}"
                                        item-label-path="label" item-value-path="value" on-selected-item-changed="getObject"
                                        object-name="data.type_academic" class="required" required>
                                        <template>
                                            [[item.label]]
                                        </template>
                                    </aqa-combo-box>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-3">
                                    <aqa-input class="required" required label="[[i18n.page01.prefix_th]]" value="{{data.prefix_th}}"></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                                    <aqa-input class="required" required label="[[i18n.page01.firstname_th]]" value="{{data.firstname_th}}" auto-validate pattern="[a-zA-Zก-์. ]*"
                                        error-message="ตัวอักษรเท่านั้น"></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-5">
                                    <aqa-input class="required" required label="[[i18n.page01.lastname_th]]" value="{{data.lastname_th}}" auto-validate pattern="[a-zA-Zก-์. ]*"
                                        error-message="ตัวอักษรเท่านั้น"></aqa-input>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-3">
                                    <aqa-input class="required" required label="[[i18n.page01.prefix_en]]" value="{{data.prefix_en}}"></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                                    <aqa-input class="required" required label="[[i18n.page01.firstname_en]]" value="{{data.firstname_en}}"></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-5">
                                    <aqa-input class="required" required label="[[i18n.page01.lastname_en]]" value="{{data.lastname_en}}"></aqa-input>
                                </div>
                            </div>
                        </div>

                    </div> -->
                </div>

                <!-- <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-2">
                        <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.gender]]" items='{{genderList}}' value="{{data.gender_id}}"
                            item-label-path="label" item-value-path="value" on-selected-item-changed="getObject" object-name="data.gender">
                            <template>
                                [[item.label]]
                            </template>
                        </aqa-combo-box>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.religion]]" items='{{religionList}}' value="{{data.religion_id}}"
                            item-label-path="label" item-value-path="value" on-selected-item-changed="getObject" object-name="data.religion">
                            <template>
                                [[item.label]]
                            </template>
                        </aqa-combo-box>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
                        <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.ethnicity]]" items='{{raceList}}' value="{{data.ethnicity_id}}"
                            item-label-path="label" item-value-path="value" on-selected-item-changed="getObject" object-name="data.race">
                            <template>
                                [[item.label]]
                            </template>
                        </aqa-combo-box>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4">
                        <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.nationality]]" items='{{nationalityList}}'
                            value="{{data.nationality_id}}" item-label-path="label" item-value-path="value" on-selected-item-changed="getObject"
                            object-name="data.nationality">
                            <template>
                                [[item.label]]
                            </template>
                        </aqa-combo-box>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-3">
                        <aqa-date-picker class="required" required value="{{data.birth_date}}">
                            <aqa-input label="[[i18n.page01.birth]]"></aqa-input>
                        </aqa-date-picker>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-2">
                        <aqa-input label="[[i18n.page01.age]]" value="{{mathAge(data.birth_date)}}" disabled></aqa-input>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <aqa-input class="required" required label="[[i18n.page01.mobile]]" type="phone" value="{{data.mobile}}"></aqa-input>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                        <aqa-input class="required" required label="[[i18n.page01.tax_no]]" value="[[info.taxno]]" type="pid" disabled></aqa-input>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                        <aqa-date-picker class="required" required value="{{data.issue_date}}">
                            <aqa-input label="[[i18n.page01.date_of_issue]]"></aqa-input>
                        </aqa-date-picker>
                    </div>

                    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-3">
                        <aqa-date-picker class="required" required value="{{data.expire_date}}">
                            <aqa-input label="[[i18n.page01.expiration_date]]"></aqa-input>
                        </aqa-date-picker>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                        <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.working_status]]" items='{{statusList}}'
                            value="{{data.status_id}}" item-label-path="label" item-value-path="value" on-selected-item-changed="getObject"
                            object-name="data.working_status">
                            <template>
                                [[item.label]]
                            </template>
                        </aqa-combo-box>
                    </div>
                </div> -->
            </div>
        </aqa-panel>
        <div style="margin:1rem"></div>
        <div class="row center-xs">
            <div class="col-lg-2">
                <div style="padding:0rem 2rem;">
                    <aqa-button type="success btn-full-width" on-tap="_save">[[i18n.button.save.label]]</aqa-button>
                </div>
            </div>
        </div>
        </div>
    </template>

    <script>
        /**
         * `page-basic-data` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class PageBasicData extends AnimateMixin(CommonMixin(ReduxMixin(Polymer.Element))) {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'page-basic-data';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    i18n: {
                        type: Object,
                        statePath: 'i18n'
                    },
                    typeAssessor: {
                        type: Array,
                        statePath: 'register.typeAssessor'
                    },
                    selectPage: {
                        type: Number,
                        value: 0
                    },
                    data: {
                        type: Object,
                        value: {
                            taxno: '',
                            type_assessor_id: 1,
                            basic: {
                                firstname_th: '',
                                lastname_th: '',
                                email: '',
                                mobile: ''
                            }
                        }
                    },
                    isCard: {
                        statePath: 'register.isCard'
                    },
                    info: {
                        type: Object,
                        statePath: 'register.info'
                    },
                    page: {
                        type: String,
                        value: '0'

                    },
                    login: {
                        type: Object,
                        value: function () {
                            return { username: '', password: '' }
                        }
                    },
                    btnBlack: {
                        type: Boolean,
                        value: false
                    }
                };
            }
            ready() {
                super.ready();

                var elem = this.$.login
                //this.fadeInDown(elem, 1, 300)
                setInterval(() => {
                    let page = () => {
                        let pageSelete = this.selectPage
                        if (pageSelete === 5) {
                            pageSelete = 0
                        } else {
                            pageSelete++
                        }
                        return pageSelete
                    }
                    this.set('selectPage', page())
                }, 3000)
            }
            _goToRegister() {
                this.set('page', 1)
                this.set('btnBlack', true)
                // console.log(this.btnBlack);
                localStorage.setItem("taxno", this.data.taxno);
                // if (this.data.taxno == '') {
                //     Nylon.dispatch('REGISTER_READER_CARD', () => {
                //         if (this.isCard) {
                //             this.set('data', {
                //                 taxno: this.info.card_id,
                //                 basic: this.info,
                //                 type_assessor_id: this.data.type_assessor_id
                //             });
                //         }
                //         if (this.validateForm('.required')) {
                //             this.checkRegister(this.info.card_id)
                //             // Nylon.dispatch('REGISTER_CHECK_TAXNO', this.info.card_id);
                //             // Nylon.dispatch('REGISTER_POST', this.data)
                //         } else {
                //             Nylon.toast('required')
                //         }
                //     });
                // } else {
                if (!this.validateForm('.required')) {
                    // this.set('data.basic', {})
                    if (this.checkPersonID(this.data.taxno)) {
                        // console.log(this.data)
                        this.checkRegister(this.data.taxno)
                    } else {
                        Nylon.toast('error')
                    }
                } else {
                    Nylon.toast('required')
                }
            }
            _btnBlack() {
                this.set('page', 0)
                this.set('btnBlack', false)
            }
            connectedCallback() {
                super.connectedCallback()
                // var elem = this.$.bg
                // console.log(elem.style);
                // setInterval(() => {
                //     var elem = this.$.bg
                //     console.log(elem.style);
                //     console.log('Hello')
                // }, 1000);
            }
            autoFill() {
                if (this.checkPersonID(this.data.taxno)) {
                    this._debouncer = Polymer.Debouncer.debounce(
                        this._debouncer, // initially undefined
                        Polymer.Async.timeOut.after(900),
                        () => {
                            Nylon.dispatch('REGISTER_CHECK_TAXNO', this.data.taxno, (data) => {
                                // console.log(data)
                                if (data.length > 0) {
                                    this.$.inputTaxNo.validate(true);
                                    // localStorage.setItem("taxno", this.data.taxno)
                                    var basic = data[0].basic
                                    this.set('data.basic.firstname_th', basic.firstname_th)
                                    this.set('data.basic.lastname_th', basic.lastname_th)
                                    this.set('data.basic.email', basic.email)
                                    this.set('data.basic.mobile', basic.mobile)
                                } else {
                                    localStorage.removeItem("taxno")
                                    this.set('data.basic.firstname_th', '')
                                    this.set('data.basic.lastname_th', '')
                                    this.set('data.basic.email', '')
                                    this.set('data.basic.mobile', '')
                                }
                            })
                        });
                } else {
                    localStorage.removeItem("taxno")
                    this.$.inputTaxNo.validate(false);
                }
            }
            nylonPagesActive() {
                Nylon.dispatch('REGISTER_GET_TYPE_ASSESSOR')
            }

            _login() {
                if (this.validateForm('.required-login')) {
                    Nylon.dispatch('authLogin', this.login)
                    localStorage.removeItem("taxno")
                } else {
                    Nylon.toast('required')
                }
            }
            _enterLogin(e) {
                if (e.code === 'Enter') {
                    this._login();
                }
            }

            _enterRegister(e) {
                if (e.code === 'Enter') {
                    this._register();
                }
            }
            _clear() {
                this.set('data.taxno', '');
                this.$.comboTypeAss.disabled = false;
            }
            _register(e) {
                // console.log(this.data.taxno)
                localStorage.setItem("taxno", this.data.taxno);
                // if (this.data.taxno == '') {
                //     Nylon.dispatch('REGISTER_READER_CARD', () => {
                //         if (this.isCard) {
                //             this.set('data', {
                //                 taxno: this.info.card_id,
                //                 basic: this.info,
                //                 type_assessor_id: this.data.type_assessor_id
                //             });
                //         }
                //         if (this.validateForm('.required')) {
                //             this.checkRegister(this.info.card_id)
                //             // Nylon.dispatch('REGISTER_CHECK_TAXNO', this.info.card_id);
                //             // Nylon.dispatch('REGISTER_POST', this.data)
                //         } else {
                //             Nylon.toast('required')
                //         }
                //     });
                // } else {
                if (this.validateForm('.required')) {
                    // this.set('data.basic', {})
                    if (this.checkPersonID(this.data.taxno)) {
                        // console.log(this.data)
                        this.checkRegister(this.data.taxno)
                    } else {
                        Nylon.toast('error')
                    }
                } else {
                    Nylon.toast('required')
                }
                // }

            }
            checkRegister(taxno) {
                Nylon.dispatch('REGISTER_CHECK_TAXNO', taxno, (data) => {
                    if (data.length > 0) {
                        if (this.data.type_assessor_id != data[0].type_assessor_id) {
                            Nylon.confirm({
                                title: this.i18n.register.title,
                                msg: this.i18n.register.warning1 + ' ' + data[0].type_assessor.type_assessor_name + ' ' + this.i18n.register.warning2,
                                icon: 'warning',
                                btn: [
                                    {
                                        label: this.i18n.button.close.label,
                                        icon: this.i18n.button.close.icon,
                                        type: 'default',
                                        'dialog-dismiss': true,
                                        action: () => {
                                            this.$.comboTypeAss.value = data[0].type_assessor_id;
                                            // this.$.comboTypeAss.disabled = true;
                                            Nylon.dispatch('REGISTER_POST', this.data)
                                        }
                                    }
                                ]
                            })
                        } else {
                            // console.log(2222);
                            Nylon.dispatch('REGISTER_POST', this.data)
                        }
                    } else {
                        Nylon.dispatch('REGISTER_POST', this.data)
                    }
                });
            }

            checkPersonID(id) {
                var check
                if (id.length != 13) check = false;
                else {
                    for (let i = 0, sum = 0; i < 12; i++) {
                        sum += parseFloat(id.charAt(i)) * (13 - i);
                        if ((11 - sum % 11) % 10 != parseFloat(id.charAt(12))) {
                            check = false;
                        }
                        else {
                            check = true;
                        }
                    }
                }
                return check
            }

        }

        window.customElements.define(PageBasicData.is, PageBasicData);
    </script>
</dom-module>