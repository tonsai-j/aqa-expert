<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../layout/shared-styles.html">
<link rel="import" href="../../../layout/flexbox-grid.html">
<link rel="import" href="../../../redux/profile/page-01-redux.html">
<link rel="import" href="../../../redux/register/register-redux.html">
<link rel="import" href="../../../redux-mixin.html">
<link rel="import" href="../../../mixins/animate-mixin.html">
<link rel="import" href="../../../i18n/profile/page-01-i18n.html">
<link rel="import" href="../../../mixins/common-mixin.html">
<!-- <link rel="import" href="../../../components/nylon-animate-css/nylon-animate-css.html"> -->
<link rel="import" href="../../../components/aqa-panel/aqa-panel.html">
<link rel="import" href="../../../components/aqa-form/aqa-input.html">
<link rel="import" href="../../../components/aqa-button/aqa-button.html">
<link rel="import" href="../../../components/aqa-title/aqa-title-name.html">
<link rel="import" href="../../../components/aqa-form/aqa-date-picker.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../components/aqa-form/aqa-combo-box.html">

<dom-module id="page-01">
    <template>
        <style include="flexbox-grid shared-styles">
            /* #example-sizing-contain {
                width: 100%;
                height: auto;
            } */

            #output_image {
                width: 100%;
                height: auto;
                min-width: 96px;
                min-height: auto;
                margin: 0 auto;
            }

            img {
                width: 100px;
                hyphens: 100px;
            }

            .img-circle {
                width: 30px;
                height: 30px;
                border-radius: 50%;
            }

            .flex-container {
                display: flex;
                justify-content: space-between;
            }

            .header-content>b {
                font-family: MitrLight;
            }

            .flex {
                display: flex;
            }

            .flex-item {
                margin: 0 auto;
            }
        </style>
        <div class="page-container">

            <aqa-title-name item=[[info.basic]]></aqa-title-name>
            <aqa-panel id="basic">
                <app-toolbar slot="header">
                    <div main-title>[[i18n.page01.basic_data]]</div>
                </app-toolbar>
                <div slot="content">
                    <div class="row center-sm" style="text-align:left">
                        <div class="col-xs-12 col-lg-10">
                            <div class="row">
                                <!-- <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                                    <aqa-input class="form" label="เลขประจำตัวประชาชน" type="pid" required></aqa-input>
                                </div> -->
                                <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                    <aqa-input class="form " label="[[i18n.page01.register]]" value="[[info.id]]" disabled></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                    <aqa-input label="[[i18n.page01.status]]" value=""></aqa-input>
                                    <!-- <aqa-input label="วันที่ออกบัตร" value=""></aqa-input> -->
                                    <!-- <aqa-date-picker id="date" label="วันที่ออกบัตร" selected="" show-bc></aqa-date-picker> -->
                                </div>
                                <div class="col-xs-12 col-sm-6 col-md-12 col-lg-4">
                                    <!-- <aqa-combo-box label="[[i18n.page01.academic]]" items="[[academicList]]" item-label-path="label" item-value-path="value"
                                        auto-validate required></aqa-combo-box> -->
                                    <!-- <aqa-combo-box label="สถานะการทำงาน" items="[[statusList]]" item-label-path="label" item-value-path="value"></aqa-combo-box>  -->
                                    <!-- {{data.type_academic_id}}// -->
                                    <aqa-combo-box always-float-label label="[[i18n.page01.academic]]" items='{{academicList}}' value="{{data.type_academic_id}}"
                                        item-label-path="label" item-value-path="value" on-selected-item-changed="getObject"
                                        object-name="data.type_academic" class="required" required>
                                        <template>
                                            [[item.label]]
                                        </template>
                                    </aqa-combo-box>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-3">
                                    <aqa-input class="required" required label="[[i18n.page01.prefix_th]]" value="{{data.prefix_th}}"></aqa-input>
                                    <!-- <aqa-combo-box class="form" label="คำนำหน้า (ไทย)" items="[[prefix]]" item-label-path="label_th" item-value-path="value"></aqa-combo-box> -->
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                                    <aqa-input class="required" required label="[[i18n.page01.firstname_th]]" value="{{data.firstname_th}}" auto-validate pattern="[a-zA-Zก-์. ]*"
                                        error-message="ตัวอักษรเท่านั้น"></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-5">
                                    <aqa-input class="required" required label="[[i18n.page01.lastname_th]]" value="{{data.lastname_th}}" auto-validate pattern="[a-zA-Zก-์. ]*"
                                        error-message="ตัวอักษรเท่านั้น"></aqa-input>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-3">
                                    <aqa-input class="required" required label="[[i18n.page01.prefix_en]]" value="{{data.prefix_en}}"></aqa-input>
                                    <!-- <aqa-combo-box class="form" label="คำนำหน้า (อังกฤษ)" items="[[prefix]]" item-label-path="label_eng" item-value-path="value"></aqa-combo-box> -->
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                                    <aqa-input class="required" required label="[[i18n.page01.firstname_en]]" value="{{data.firstname_en}}"></aqa-input>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-5">
                                    <aqa-input class="required" required label="[[i18n.page01.lastname_en]]" value="{{data.lastname_en}}"></aqa-input>
                                </div>
                            </div>
                        </div>
                        <div class="first-xs last-lg col-xs-12 col-sm-4 col-lg-2">
                            <div>
                                <!-- <div class="flex-item"> -->
                                <img id="output_image" src$="[[pic_url]]" style="
                                width: 170px;
                                height: 200px;
                            " />
                                <input type="file" id="upFile" on-change="fileChange" hidden>
                                <aqa-button type="primary btn-full-width" icon="icons:file-upload" style="max-width:96px" on-tap="upLoadFile">[[i18n.page01.upload]]</aqa-button>
                                <!-- </div> -->
                            </div>
                            <div style="margin:1rem"></div>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-2">

                            <!-- <aqa-combo-box label="[[i18n.page01.gender]]" items="[[genderList]]" value="{{data.gender_id}}" item-label-path="label" 
                            item-value-path="value"></aqa-combo-box> -->
                            <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.gender]]" items='{{genderList}}' value="{{data.gender_id}}"
                                item-label-path="label" item-value-path="value" on-selected-item-changed="getObject" object-name="data.gender">
                                <template>
                                    [[item.label]]
                                </template>
                            </aqa-combo-box>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                            <!-- ศาสนา -->
                            <!-- <aqa-combo-box label="[[i18n.page01.religion]]" items="[[religionList]]" item-label-path="label" item-value-path="value"></aqa-combo-box> -->
                            <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.religion]]" items='{{religionList}}' value="{{data.religion_id}}"
                                item-label-path="label" item-value-path="value" on-selected-item-changed="getObject" object-name="data.religion">
                                <template>
                                    [[item.label]]
                                </template>
                            </aqa-combo-box>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <!-- เชื้อชาติ -->
                            <!-- <aqa-combo-box label="[[i18n.page01.ethnicity]]" items="[[raceList]]" item-label-path="label" item-value-path="value"></aqa-combo-box> -->
                            <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.ethnicity]]" items='{{raceList}}' value="{{data.ethnicity_id}}"
                                item-label-path="label" item-value-path="value" on-selected-item-changed="getObject" object-name="data.race">
                                <template>
                                    [[item.label]]
                                </template>
                            </aqa-combo-box>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4">
                            <!-- สัญชาติ -->
                            <!-- <aqa-combo-box label="[[i18n.page01.nationality]]" items="[[nationalityList]]" item-label-path="label" item-value-path="value"></aqa-combo-box> -->
                            <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.nationality]]" items='{{nationalityList}}'
                                value="{{data.nationality_id}}" item-label-path="label" item-value-path="value" on-selected-item-changed="getObject"
                                object-name="data.nationality">
                                <template>
                                    [[item.label]]
                                </template>
                            </aqa-combo-box>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-3">
                            <aqa-date-picker class="required" required value="{{data.birth_date}}">
                                <aqa-input label="[[i18n.page01.birth]]"></aqa-input>
                            </aqa-date-picker>
                            <!-- <aqa-date-picker id="date" label="วัน/เดือน/ปี เกิด" selected="{{birthDay}}" show-bc></aqa-date-picker> -->
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-2">
                            <aqa-input label="[[i18n.page01.age]]" value="{{mathAge(data.birth_date)}}" disabled></aqa-input>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                            <aqa-input class="required" required label="[[i18n.page01.mobile]]" type="phone" value="{{data.mobile}}"></aqa-input>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                            <aqa-input class="required" required label="[[i18n.page01.tax_no]]" value="[[info.taxno]]" type="pid" disabled></aqa-input>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                            <aqa-date-picker class="required" required value="{{data.issue_date}}">
                                <aqa-input label="[[i18n.page01.date_of_issue]]"></aqa-input>
                            </aqa-date-picker>
                            <!-- <aqa-date-picker id="date" label="วันที่ออกบัตร" selected="" show-bc></aqa-date-picker> -->
                        </div>

                        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-3">
                            <aqa-date-picker class="required" required value="{{data.expire_date}}">
                                <aqa-input label="[[i18n.page01.expiration_date]]"></aqa-input>
                            </aqa-date-picker>
                            <!-- <aqa-date-picker id="date" label="วันที่บัตรหมดอายุ" selected="" show-bc></aqa-date-picker> -->
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                            <!-- <aqa-combo-box label="[[i18n.page01.working_status]]" items="[[statusList]]" item-label-path="label" item-value-path="value"></aqa-combo-box> -->
                            <aqa-combo-box class="required" required always-float-label label="[[i18n.page01.working_status]]" items='{{statusList}}'
                                value="{{data.status_id}}" item-label-path="label" item-value-path="value" on-selected-item-changed="getObject"
                                object-name="data.working_status">
                                <template>
                                    [[item.label]]
                                </template>
                            </aqa-combo-box>
                        </div>
                    </div>
                </div>
            </aqa-panel>
            <div style="margin:1rem"></div>
            <div class="row center-xs">
                <div class="col-lg-2">
                    <div style="padding:0rem 2rem;">
                        <aqa-button type="success btn-full-width" on-tap="_save">[[i18n.button.save.label]]</aqa-button>
                    </div>
                </div>
            </div>
        </div>




        <paper-toast id="toast" horizontal-align="right" vertical-align="bottom" text="[[i18n.toast.save]]"></paper-toast>


    </template>

    <script>
        class Page01 extends AnimateMixin(CommonMixin(ReduxMixin(Polymer.Element))) {

            static get is() {
                return 'page-01';
            }


            static get properties() {
                return {
                    i18n: {
                        type: Object,
                        statePath: 'i18n'
                    },
                    rootPath: {
                        type: String,
                    },
                    academicList: {
                        statePath: 'profile_page01.academicPosition'
                    },
                    genderList: {
                        statePath: 'profile_page01.gender'
                    },
                    raceList: {
                        statePath: 'profile_page01.race'
                    },
                    religionList: {
                        statePath: 'profile_page01.religion'
                    },
                    nationalityList: {
                        statePath: 'profile_page01.nationality'
                    },
                    statusList: {
                        statePath: 'profile_page01.workStatus'
                    },
                    info: {
                        type: Object,
                        statePath: 'profile.info'
                    },
                    basic: {
                        type: Object,
                        statePath: 'profile.info.basic',
                        observer: 'cutdate'
                    },
                    data: {
                        type: Object,
                        value: {}
                    },
                    age: {
                        type: Number,
                        value: 0
                    },
                    file: {
                        type: Object,
                        value: {}
                    },
                    pic_url: {
                        type: String,
                    },
                    url: {
                        type: String,
                        statePath: 'profile_page01.url',
                        observer: 'setUrlBank'
                    }
                };
            }
            constructor() {
                super();

            }
            // nylonPagesActive(){
            //     console.log(1212121212)
            //     Nylon.dispatch('REGISTER_CHECK_PERSON')
            // }
            ready() {
                // console.log(this.genderList)
                super.ready();
                var elem = this.$.basic
                //this.fadeInDown(elem, 1, 500)
                Polymer.RenderStatus.afterNextRender(this, function () {
                    Nylon.dispatch('PROFILE_01_GET_LIST_ACADAMIC_POSITION')
                    Nylon.dispatch('PROFILE_01_GET_LIST_GENDER')
                    Nylon.dispatch('PROFILE_01_GET_LIST_NATIONALITY')
                    Nylon.dispatch('PROFILE_01_GET_LIST_RACE')
                    Nylon.dispatch('PROFILE_01_GET_LIST_RELIGION')
                    Nylon.dispatch('PROFILE_01_GET_LIST_WORK_STATUS')
                    // Nylon.dispatch('REGISTER_CHECK_PERSON', localStorage.getItem('taxno'))
                });
            }
            upLoadFile() {
                this.$.upFile.click()
            }
            fileChange(e) {
                // console.log(e);
                let reader = new FileReader()
                reader.onload = () => {
                    var output = this.$.output_image
                    output.src = reader.result
                }
                this.set('file', event.target.files[0])
                // console.log(event.target.files[0]);
                reader.readAsDataURL(event.target.files[0])
                let profile = {
                    pic_type: 'profile',
                    user_id: this.info.id
                }
                Nylon.dispatch('PROFILE_01_POST_PICTURE', this.file, profile)
            }
            setUrlBank(url) {
                // console.log(url);
                if (this.basic === undefined)
                    return ''
                this.set('basic.profile_url', url.url)
                this.set('data.profile_url', url.url)
            }
            _openDropDown(e) {
                e.currentTarget.previousElementSibling.open()
                // console.log(111);
            }
            cutdate(date) {
                if (this.info !== undefined) {
                    if (this.info.hasOwnProperty('id')) {
                        Date.prototype.addHours = function (h) {
                            this.setTime(this.getTime() + (h * 60 * 60 * 1000));
                            return this;
                        }
                        if (date.birth_date !== undefined)
                            date.birth_date = new Date(date.birth_date).addHours(7).toISOString().split('T')[0]
                        if (date.issue_date !== undefined)
                            date.issue_date = new Date(date.issue_date).addHours(7).toISOString().split('T')[0]
                        if (date.expire_date !== undefined)
                            date.expire_date = new Date(date.expire_date).addHours(7).toISOString().split('T')[0]
                        // console.log(this.info);
                        if (this.info.basic.profile_url !== undefined && this.info.basic.profile_url !== '') {
                            this.set('pic_url', this.info.basic.profile_url)
                            this.set('data.profile_url', this.info.basic.profile_url)
                        } else {
                            this.set('pic_url', this.rootPath + '/images/icon-img.png')
                            this.set('data.profile_url', this.rootPath + '/images/icon-img.png')
                        }
                        // console.log(date);
                        this.set('data', date)
                    }
                }

            }
            preview_image(e) {
                var reader = new FileReader()
                reader.onload = () => {
                    var output = this.$.output_image
                    output.src = reader.result
                }
                reader.readAsDataURL(event.target.files[0])
            }
            _save() {
                // console.log(this.info.id)
                // console.log(this.validateForm('.required'));
                if (this.validateForm('.required')) {
                    let newDataSave = JSON.parse(JSON.stringify(this.data))
                    // console.log(newDataSave)
                    newDataSave.birth_date = new Date(newDataSave.birth_date).toISOString()
                    newDataSave.issue_date = new Date(newDataSave.issue_date).toISOString()
                    newDataSave.expire_date = new Date(newDataSave.expire_date).toISOString()
                    // console.log(newDataSave);
                    Nylon.dispatch('PROFILE_UPDATE', this.info.id, 'basic', newDataSave,
                        () => {
                            Nylon.dialog('save')
                        }
                    )

                } else {
                    Nylon.toast('required')
                }

            }
            _calcAge(date) {
                if (date !== undefined) {
                    var age = new Date(new Date - new Date(date)).getFullYear() - 1970;
                    if (age < 0) age = 0;
                    this.set('age', age);
                }
            }
            _setDate() {
                Date.prototype.addHours = (h) => {
                    this.setHours(this.getHours() + h);
                    return this;
                }
            }
            _readIDCard() {
                Nylon.dispatch('REGISTER_READER_CARD', (isReadCard) => {
                    Date.prototype.addHours = function (h) {
                        this.setTime(this.getTime() + (h * 60 * 60 * 1000));
                        return this;
                    }
                    if (isReadCard.hasOwnProperty('card_id')) {
                        // console.log(1);
                        isReadCard.birth_date = new Date(isReadCard.birth_date).addHours(7).toISOString().split('T')[0]
                        isReadCard.issue_date = new Date(isReadCard.issue_date).addHours(7).toISOString().split('T')[0]
                        isReadCard.expire_date = new Date(isReadCard.expire_date).addHours(7).toISOString().split('T')[0]
                        this.set('data', isReadCard)
                        Nylon.toast('insert')
                    } else {
                        Nylon.toast('error', this.i18n.page01.error)
                    }
                })
            }
            calAge(dateString) {
                if (dateString === undefined || dateString === '')
                    return ''
                var now = new Date();
                var today = new Date(now.getYear(), now.getMonth(), now.getDate());

                var yearNow = now.getYear();
                var monthNow = now.getMonth();
                var dateNow = now.getDate();

                var dob = new Date(dateString);

                var yearDob = dob.getYear();
                var monthDob = dob.getMonth();
                var dateDob = dob.getDate();
                var age = {};
                var ageString = "";
                var yearString = "";
                var monthString = "";
                var dayString = "";


                let yearAge = yearNow - yearDob;

                if (monthNow >= monthDob)
                    var monthAge = monthNow - monthDob;
                else {
                    yearAge--;
                    var monthAge = 12 + monthNow - monthDob;
                }

                if (dateNow >= dateDob)
                    var dateAge = dateNow - dateDob;
                else {
                    monthAge--;
                    var dateAge = 31 + dateNow - dateDob;

                    if (monthAge < 0) {
                        monthAge = 11;
                        yearAge--;
                    }
                }

                age = {
                    years: yearAge,
                    months: monthAge,
                    days: dateAge
                };

                if (age.years > 1) yearString = " ปี";
                else yearString = " ปี";
                if (age.months > 1) monthString = " เดือน";
                else monthString = " เดือน";
                if (age.days > 1) dayString = " วัน";
                else dayString = " วัน";


                // if ((age.years > 0) && (age.months > 0) && (age.days > 0))
                //     ageString = age.years + yearString + " " + age.months + monthString + " " + age.days + dayString
                // else if ((age.years == 0) && (age.months == 0) && (age.days > 0))
                //     ageString = age.days + dayString
                // else if ((age.years > 0) && (age.months == 0) && (age.days == 0))
                //     ageString = age.years + yearString + " old. Happy Birthday!!";
                // else if ((age.years > 0) && (age.months > 0) && (age.days == 0))
                //     ageString = age.years + yearString + " " + age.months + monthString
                // else if ((age.years == 0) && (age.months > 0) && (age.days > 0))
                //     ageString = age.months + monthString + " " + age.days + dayString
                // else if ((age.years > 0) && (age.months == 0) && (age.days > 0))
                //     ageString = age.years + yearString + " " + age.days + dayString
                // else if ((age.years == 0) && (age.months > 0) && (age.days == 0))
                //     ageString = age.months + monthString
                // else ageString = "ไม่สามารถคำนวนอายุได้!";

                if ((age.years > 0) && (age.months > 0) && (age.days > 0))
                    ageString = age.years + yearString + " " + age.months + monthString + " "
                else if ((age.years == 0) && (age.months == 0) && (age.days > 0))
                    ageString = age.days + dayString
                else if ((age.years > 0) && (age.months == 0) && (age.days == 0))
                    ageString = age.years + yearString + " สุขสันต์วันเกิด!!";
                else if ((age.years > 0) && (age.months > 0) && (age.days == 0))
                    ageString = age.years + yearString + " " + age.months + monthString
                else if ((age.years == 0) && (age.months > 0) && (age.days > 0))
                    ageString = age.months + monthString
                else if ((age.years > 0) && (age.months == 0) && (age.days > 0))
                    ageString = age.years + yearString
                else if ((age.years == 0) && (age.months > 0) && (age.days == 0))
                    ageString = age.months + monthString
                else ageString = "ไม่สามารถคำนวนอายุได้!";

                return ageString;

            }
            mathAge(date) {
                // console.log('ss', date)
                return this.calAge(date)
            }
        }



        window.customElements.define(Page01.is, Page01);
    </script>
</dom-module>