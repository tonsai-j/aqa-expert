<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../layout/flexbox-grid.html">
<link rel="import" href="../../components/nylon-panel-card/nylon-panel-card.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<!-- <link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html"> -->
<link rel="import" href="../../components/nylon-input/nylon-combo-box.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">

<link rel="import" href="../../mixins/common-mixin.html">

<link rel="import" href="../../layout/shared-styles.html">
<link rel="import" href="../../redux-mixin.html">
<link rel="import" href="../../redux/register/register-redux.html">
<link rel="import" href="../../i18n/register/main-i18n.html">

<link rel="import" href="../../components/nylon-input/nylon-input.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../redux/profile/profile-redux.html">

<dom-module id="page-register">
    <template>
        <style include="shared-styles flexbox-grid flexbox-grid-remove-padding ">
            .row {
                padding-right: 0rem;
                padding-left: 0rem;
            }

            .header {
                top: 50%;
                text-align: center;
                line-height: 3em;
                color: #89BCEB
            }

            .container {
                padding-top: 8%;
            }

            .intut-title {
                text-align: left;
            }

            .input {
                text-align: left;
            }

            paper-tabs {
                color: #fff;
                border: 1px solid #4E97D9;
                --paper-tabs-selection-bar: {
                    display: none;
                }
                /* border: 1 solid #4E97D9; */
                /* --paper-tabs-selection-bar: {
                    color: #FFFFFF;
                    background: #4E97D9;
                }
                --paper-tab-content: {
                    color: #FFFFFF;
                }
                --paper-tabs-content:{
                     border: 1px solid #4E97D9;
                }
                --paper-tabs-container: {
                    color: #FFFFFF;
                    margin:0px;
                } */
                /* --paper-tab-content-unselected: {
                    color: #4E97D9;
                    background-color: #FFFFFF;
                } */
            }

            paper-tab {
                --paper-tab-ink: #89BCEB;
                --paper-tab-content-unselected: {
                    color: #4E97D9;
                }
            }

            paper-tab.iron-selected {
                color: white;
                background-color: #4E97D9;
            }
        </style>
        <!-- <div class="container row center-md center-lg center-sm">
            <div class="col-lg-5 col-md-8  col-sm-10  col-xs-12">
                <nylon-panel-card id="panelCard">
                    <div slot="header">
                        <div class="header">
                            <h3>[[i18n.register.title]]</h3>
                        </div>
                    </div>
                    <div slot="content" class="middle-md">
                        <div class="col-xs-12">
                                <nylon-input id="inputTaxNo" class="required input" required label="[[i18n.register.taxno]]" value="{{data.taxno}}" allowed-pattern="[0-9]"
                                maxlength="13" required on-keyup="_enter" always-float-label
                                ></nylon-input>
                        </div>
                        <div class="col-xs-12">
                            <nylon-combo-box id="comboTypeAss" class="required input" required label="[[i18n.register.level]]" items='{{typeAssessor}}'
                                value="{{data.type_assessor_id}}" item-label-path="type_assessor_name" item-value-path="id">
                                <template>
                                    [[item.type_assessor_name]]
                                </template>
                            </nylon-combo-box>
                        </div>
                    </div>
                    <app-toolbar slot="footer">
                        <div main-title></div>
                        <paper-button raised class="btn-default" on-click="_clear">
                            <iron-icon icon="[[i18n.button.reset.icon]]"></iron-icon>&nbsp;[[i18n.button.reset.label]]
                        </paper-button>
                        <paper-button raised class="btn-success" on-click="_register">
                            <iron-icon icon="[[i18n.button.register.icon]]"></iron-icon>&nbsp;[[i18n.button.register.label]]
                        </paper-button>
                    </app-toolbar>
                </nylon-panel-card>
            </div>
        </div> -->
        <div class="container row center-md center-lg center-sm">
            <div class="col-lg-4 col-md-12  col-sm-3  col-xs-12">
                <nylon-panel-card id="panelCard">
                    <div slot="header">
                        <div class="header">
                            <h3>AUTOMATED QA</h3>
                        </div>
                    </div>

                    <div slot="content" class="middle-md">
                        <paper-tabs selected={{page}}>
                            <paper-tab>[[i18n.register.login]]</paper-tab>
                            <paper-tab>[[i18n.register.title]]</paper-tab>
                        </paper-tabs>
                        <iron-pages selected={{page}}>
                            <div>
                                <div class="col-xs-12">
                                    <nylon-input class="input" label="[[i18n.register.user]]" value="{{login.username}}" always-float-label></nylon-input>
                                </div>
                                <div class="col-xs-12">
                                    <nylon-input type="password" class="input" label="[[i18n.register.password]]" value="{{login.password}}" always-float-label></nylon-input>
                                </div>
                                <!-- <app-toolbar slot="footer">
                                    <div main-title></div> -->
                                <div style="margin:20px"></div>
                                <paper-button raised class="btn-success col-xs-12 row center-md" on-click="_login">
                                    <iron-icon icon="[[i18n.button.register.icon]]"></iron-icon>&nbsp;[[i18n.button.login.label]]
                                </paper-button>
                                <!-- </app-toolbar> -->
                            </div>
                            <div>
                                <div class="col-xs-12">
                                    <nylon-input id="inputTaxNo" class="required input" required label="[[i18n.register.taxno]]" value="{{data.taxno}}" pattern="^(\d{13})?$"
                                        required on-keyup="autoFill" always-float-label></nylon-input>
                                </div>
                                <div class="col-xs-12">
                                    <nylon-input class="required input" required label=[[i18n.register.name]] value="{{data.basic.firstname_th}}" required on-keyup="_enter"
                                        always-float-label></nylon-input>
                                </div>
                                <div class="col-xs-12">
                                    <nylon-input class="required input" required label=[[i18n.register.lname]] value="{{data.basic.lastname_th}}" required on-keyup="_enter"
                                        always-float-label></nylon-input>
                                </div>
                                <div class="col-xs-12">
                                    <nylon-input class="required input" required label=[[i18n.register.phone]] value="{{data.basic.mobile}}" required on-keyup="_enter"
                                        always-float-label></nylon-input>
                                </div>
                                <div class="col-xs-12">
                                    <nylon-input class="required input" required label=[[i18n.register.email]] value="{{data.basic.email}}" required on-keyup="_enter"
                                        always-float-label></nylon-input>
                                </div>
                                <div class="col-xs-12">
                                    <nylon-combo-box id="comboTypeAss" class="required input" required label="[[i18n.register.level]]" items='{{typeAssessor}}'
                                        value="{{data.type_assessor_id}}" item-label-path="type_assessor_name" item-value-path="id">
                                        <template>
                                            [[item.type_assessor_name]]
                                        </template>
                                    </nylon-combo-box>
                                </div>
                                <!-- <app-toolbar slot="footer"> -->
                                <!-- <div main-title></div> -->
                                <div style="margin:20px"></div>
                                <paper-button raised class="btn-success col-xs-12 row center-md" on-click="_register">
                                    <iron-icon icon="[[i18n.button.register.icon]]"></iron-icon>&nbsp;[[i18n.button.register.label]]
                                </paper-button>
                                <!-- </app-toolbar> -->
                            </div>
                        </iron-pages>
                    </div>
                </nylon-panel-card>
            </div>
        </div>
    </template>

    <script>
        /**
         * `page-register` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class PageRegister extends CommonMixin(ReduxMixin(Polymer.Element)) {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'page-register';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    i18n: {
                        type: Object,
                        statePath: 'i18n'
                    },
                    typeAssessor: {
                        type: Array,
                        statePath: 'register.typeAssessor'
                    },
                    data: {
                        type: Object,
                        value: {
                            taxno: '',
                            type_assessor_id: 1,
                            basic: {
                                firstname_th: '',
                                lastname_th: '',
                                email: '',
                                mobile: ''
                            }
                        }
                    },
                    isCard: {
                        statePath: 'register.isCard'
                    },
                    info: {
                        type: Object,
                        statePath: 'register.info'
                    },
                    page: {
                        type: String,
                        value: '0'

                    },
                    login: {
                        type: Object,
                        value: function () {
                            return { username: '', password: '' }
                        }
                    }
                };
            }
            ready() {
                super.ready();

            }
            autoFill() {
                if (this.checkPersonID(this.data.taxno)) {
                    this._debouncer = Polymer.Debouncer.debounce(
                        this._debouncer, // initially undefined
                        Polymer.Async.timeOut.after(900),
                        () => {
                            Nylon.dispatch('REGISTER_CHECK_TAXNO', this.data.taxno, (data) => {
                                console.log(data)
                                if (data.length > 0) {
                                    this.$.inputTaxNo.validate(true);
                                    var basic = data[0].basic
                                    this.set('data.basic.firstname_th', basic.firstname_th)
                                    this.set('data.basic.lastname_th', basic.lastname_th)
                                    this.set('data.basic.email', basic.email)
                                    this.set('data.basic.mobile', basic.mobile)
                                } else {
                                    this.set('data.basic.firstname_th', '')
                                    this.set('data.basic.lastname_th', '')
                                    this.set('data.basic.email', '')
                                    this.set('data.basic.mobile', '')
                                }
                            })
                        });
                } else {
                    this.$.inputTaxNo.validate(false);
                }
            }
            nylonPagesActive() {
                Nylon.dispatch('REGISTER_GET_TYPE_ASSESSOR')
            }

            _login() {
                Nylon.dispatch('authLogin', this.login)
            }

            _enter(e) {
                if (e.code === 'Enter') {
                    this._register();
                }
            }
            _clear() {
                this.set('data.taxno', '');
                this.$.comboTypeAss.disabled = false;
            }
            _register(e) {
                // console.log(this.data.taxno)
                localStorage.setItem("taxno", this.data.taxno);
                // if (this.data.taxno == '') {
                //     Nylon.dispatch('REGISTER_READER_CARD', () => {
                //         if (this.isCard) {
                //             this.set('data', {
                //                 taxno: this.info.card_id,
                //                 basic: this.info,
                //                 type_assessor_id: this.data.type_assessor_id
                //             });
                //         }
                //         if (this.validateForm('.required')) {
                //             this.checkRegister(this.info.card_id)
                //             // Nylon.dispatch('REGISTER_CHECK_TAXNO', this.info.card_id);
                //             // Nylon.dispatch('REGISTER_POST', this.data)
                //         } else {
                //             Nylon.toast('required')
                //         }
                //     });
                // } else {
                if (this.validateForm('.required')) {
                    // this.set('data.basic', {})
                    if (this.checkPersonID(this.data.taxno)) {
                        // console.log(this.data)
                        this.checkRegister(this.data.taxno)
                    } else {
                        Nylon.toast('error')
                    }
                } else {
                    Nylon.toast('required')
                }
                // }

            }
            checkRegister(taxno) {
                Nylon.dispatch('REGISTER_CHECK_TAXNO', taxno, (data) => {
                    if (data.length > 0) {
                        if (this.data.type_assessor_id != data[0].type_assessor_id) {
                            Nylon.confirm({
                                title: this.i18n.register.title,
                                msg: this.i18n.register.warning1 + ' ' + data[0].type_assessor.type_assessor_name + ' ' + this.i18n.register.warning2,
                                icon: 'warning',
                                btn: [
                                    {
                                        label: this.i18n.button.close.label,
                                        icon: this.i18n.button.close.icon,
                                        class: 'btn-default',
                                        'dialog-dismiss': true,
                                        action: () => {
                                            this.$.comboTypeAss.value = data[0].type_assessor_id;
                                            // this.$.comboTypeAss.disabled = true;
                                            Nylon.dispatch('REGISTER_POST', this.data)
                                        }
                                    }
                                ]
                            })
                        } else {
                            // console.log(2222);
                            Nylon.dispatch('REGISTER_POST', this.data)
                        }
                    } else {
                        Nylon.dispatch('REGISTER_POST', this.data)
                    }
                });
            }

            checkPersonID(id) {
                var check
                if (id.length != 13) check = false;
                else {
                    for (let i = 0, sum = 0; i < 12; i++) {
                        sum += parseFloat(id.charAt(i)) * (13 - i);
                        if ((11 - sum % 11) % 10 != parseFloat(id.charAt(12))) {
                            check = false;
                        }
                        else {
                            check = true;
                        }
                    }
                }
                return check
            }

        }

        window.customElements.define(PageRegister.is, PageRegister);
    </script>
</dom-module>