<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">

<link rel="import" href="../../components/nylon-panel-card/nylon-panel-card.html">
<link rel="import" href="../../components/nylon-c3/nylon-c3.html">

<link rel="import" href="../../redux-mixin.html">
<link rel="import" href="../../redux/dashboard/dashboard-redux.html">
<link rel="import" href="../../layout/shared-styles.html">



<dom-module id="page-dashboard">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      .font {
        @apply --nylon-font-mitr-family
      }

      .font-bone {
        @apply --nylon-font-mitr-family-bone;
      }

      .container-dashboard {
        background-color: #3399ff;
      }

      nylon-panel-card {
        margin: 5px
      }
    </style>

    <div class="container">
      <div class="row user">

        <div class="col-xs-6 ">
              <div main-title class="font">ค่าใช้จ่าย</div>
            <nylon-c3 slot="content" id="chart1_user"></nylon-c3>
        </div>

        <div class="col-xs-6 ">
              <div main-title class="font">ประวัติการประเมินสถานศึกษา</div>
            <nylon-c3 slot="content" id="chart3_user"></nylon-c3>
        </div>

        <div class="col-xs-12">
          <div main-title class="font">สรุปความก้าวหน้า</div>
          <nylon-c3 slot="content" id="chart2_user"></nylon-c3>
        </div>

      </div>
    </div>

    <div class="container">
      <div class="row admin">
        <div class="col-xs-6 ">
          <nylon-panel-card>
            <app-toolbar slot="header">
              <div main-title class="font">ค่าใช้จ่ายโดยรวม</div>
            </app-toolbar>
            <nylon-c3 slot="content" id="chart1_admin"></nylon-c3>
          </nylon-panel-card>
        </div>


        <div class="col-xs-6 ">
          <nylon-panel-card>
            <app-toolbar slot="header">
              <div main-title class="font">ผู้เข้าอบรม</div>
            </app-toolbar>
            <nylon-c3 slot="content" id="chart2_admin"></nylon-c3>
          </nylon-panel-card>
        </div>


        <div class="col-xs-12 ">
          <nylon-panel-card>
            <app-toolbar slot="header">
              <div main-title class="font">สรุปผลการประเมินสถานศึกษา</div>
            </app-toolbar>
            <nylon-c3 slot="content" id="chart3_admin"></nylon-c3>
          </nylon-panel-card>
        </div>


        <div class="col-xs-12">
          <nylon-panel-card>
            <app-toolbar slot="header">
              <div main-title class="font">สรุปความก้าวหน้า</div>
            </app-toolbar>
            <nylon-c3 slot="content" id="chart4_admin"></nylon-c3>
          </nylon-panel-card>
        </div>

      </div>
    </div>
  </template>

  <script>
    class PageDashboard extends ReduxMixin(Polymer.Element) {
      static get is() { return 'page-dashboard' }
      static get properties() {
        return {
          auth: {
            type: String,
            statePath: 'auth.user',
          },
          expenses: {
            type: Object,
            statePath: 'dashboard.expenses',
            observer: 'expenses_change'
          },
          participant: {
            type: Object,
            statePath: 'dashboard.participant',
            observer: 'participant_change'
          }
        }

      }

      connectedCallback() {
        super.connectedCallback()

        if (this.auth.admin == true) {
          Nylon.dispatch('DASHBOARD_GET_EXPENSES')
          Nylon.dispatch('DASHBOARD_GET_PARTICIPANT')
          this.shadowRoot.querySelector('.user').style.display = 'none'

        } else {
          // Nylon.dispatch('DASHBOARD_GET_EXPENSES', this.auth.taxno)
          Nylon.dispatch('DASHBOARD_GET_EXPENSES', '1909800788263')
          this.shadowRoot.querySelector('.admin').style.display = 'none'

        }
      }

      formatMoney(inum) {  // ฟังก์ชันสำหรับแปลงค่าตัวเลขให้อยู่ในรูปแบบ เงิน
        var s_inum = new String(inum);
        var num2 = s_inum.split(".");
        var n_inum = "";
        if (num2[0] != undefined) {
          var l_inum = num2[0].length;
          for (var i = 0; i < l_inum; i++) {
            if (parseInt(l_inum - i) % 3 == 0) {
              if (i == 0) {
                n_inum += s_inum.charAt(i);
              } else {
                n_inum += "," + s_inum.charAt(i);
              }
            } else {
              n_inum += s_inum.charAt(i);
            }
          }
        } else {
          n_inum = inum;
        }
        if (num2[1] != undefined) {
          n_inum += "." + num2[1];
        }
        return n_inum;
      }

      expenses_change(e) {
        // console.log(e)
        var columns = []
        var expenses_list = []

        for (var i in e) {
          if (e[i].amount != 0) {
            columns.push([e[i].group_expenses_name + ' ' + this.formatMoney(e[i].price) + '฿', Number(e[i].percentage.toFixed(2))])

          }
          expenses_list.push({
            name: e[i].group_expenses_name,
            percentage: Number(e[i].percentage.toFixed(2)),
            price: e[i].price,
            amount: e[i].amount
          })
        }

        if (this.auth.admin == true) {

          this.$.chart1_admin.generate({
            data: {
              columns,
              type: 'pie',
              onclick: function (d, i) { console.log("onclick", d, i); }
            },
            size: {
              height: 250
            },
            color: {
              pattern: ['#348ea9', '#53bb9b', '#f48c37', '#f04946', '#fab41c']
            }
          })

          this.$.chart3_admin.generate({
            data: {
              columns: [
                ['ดีมาก', 60, 61, 58, 46],
                ['ดี', 25, 20, 18, 20],
                ['พอใช้', 10, 15, 17, 19],
                ['ต้องปรับปรุง', 3, 5, 4, 5],
                ['ต้องปรับปรุงเร่งด่วน', 2, 1, 3, 2]
              ],
            },
            axis: {
              x: {
                type: 'category',
                categories: ['ปี 2558', 'ปี 2559', 'ปี 2560', 'ปี 2561']
              },
              y: {
                label: 'จำนวนเปอร์เซ็นต์',
              }
            },
            size: {
              height: 350
            },
            color: {
              pattern: ['#339933', '#00ff00', '#f47820', '#0000cc', '#ff0000']
            }
          })

          this.$.chart4_admin.generate({
            data: {
              columns: [
                ['จากจำนวน 1,000 โรงเรียนคิดเป็น', 70, 60, 55, 50, 30, 10]
              ],
            },
            axis: {
              x: {
                label: 'ขั้นตอนกระบวนการ',
                type: 'category',
                categories: ['จัดกลุ่ม', 'ส่งแผนการดำเนินงาน', 'เข้าประเมินสถานศึกษา', 'ตรวจร่างรายงาน', 'อภิมาน', 'ส่งรายงานฉบับสมบูรณ์']
              },
              y: {
                label: 'จำนวนเปอร์เซ็นต์'
              }
            },
            size: {
              height: 350
            },
            color: {
              pattern: ['#0000cc']
            },
            legend: {
              show: false
            }
          })

        } else {

          this.$.chart1_user.generate({
            data: {
              columns,
              type: 'pie',
              onclick: function (d, i) { console.log("onclick", d, i); }
            },
            size: {
              height: 250
            },
            color: {
              pattern: ['#348ea9', '#53bb9b', '#f48c37', '#f04946', '#fab41c']
            }
          })
          this.$.chart2_user.generate({
            data: {
              columns: [
                ['จำนวนเปอร์เซ็นต์', 100, 80, 75, 70, 60, 55, 50, 30, 10]
              ],
            },
            axis: {
              x: {
                label: 'ขั้นตอนกระบวนการ',
                type: 'category',
                tick: {
                  rotate: 65,
                  multiline: false
                },
                categories: ['สถานศึกษาที่เข้าประเมิน', 'ทำสัญญา', 'ส่งแผนการดำเนินงาน', 'เบิกงวด 1'
                  , 'เข้าประเมินสถานศึกษา', 'ตรวจร่างรายงาน', 'อภิมาน', 'ส่งรายงานฉบับสมบูรณ์', 'เบิกงวด 2']
              },
              y: {
                label: 'จำนวนเปอร์เซ็นต์'
              }
            },
            size: {
              height: 500
            },
            color: {
              pattern: ['#0000cc']
            },
            legend: {
              show: false
            }
          })


          this.$.chart3_user.generate({
            data: {
              columns: [
                ['จำนวนสถานศึกษา', 0, 2, 4, 0, 0, 0],
              ],
              type: 'bar'
            },
            axis: {
              x: {
                label: 'กลุ่มระดับการศึกษาและประเภท',
                type: 'category',
                tick: {
                  rotate: 0,
                  multiline: false
                },
                categories: ['กลุ่ม 1', 'กลุ่ม 2', 'กลุ่ม 3', 'กลุ่ม 4'
                  , 'กลุ่ม 5', 'กลุ่ม 6']
              },
              y: {
                label: 'จำนวนสถานศึกษา'
              }
            },
            bar: {
              width: {
                ratio: 0.4 // this makes bar width 50% of length between ticks
              }
              // or
              //width: 100 // this makes bar width 100px
            },
            size: {
              height: 250
            },
            color: {
              pattern: ['#f48c37']
            },
          })
        }
      }


      participant_change(e) {
        // console.log(e)
        var invite_data = ['เชิญ']
        var email_data = ['ตอบรับ']
        var confirm_data = ['เข้าร่วม']
        var x_label = []
        for (var i in e) {
          invite_data.push(e[i].invite)
          email_data.push(e[i].email)
          confirm_data.push(e[i].confirm)
          x_label.push(e[i].group)
        }
        var data = [
          invite_data,
          email_data,
          confirm_data
        ]
        // console.log(data)
        this.$.chart2_admin.generate({
          data: {
            columns: data,
            type: 'bar'
          },
          axis: {
            x: {
              type: 'category',
              categories: x_label
            }
          },
          bar: {
            width: {
              ratio: 0.5
            }
          },
          size: {
            height: 250
          },
          color: {
            pattern: ['#35c1d0', '#147fae', '#094266']
          }

        })

      }
    }

    window.customElements.define(PageDashboard.is, PageDashboard);
  </script>
</dom-module>